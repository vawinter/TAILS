---
title: "T.A.I.L.S: Animal movement visualization"
author: "V. Winter, K. Beatty, M. Stum"
date: "11/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Animal movement visualization

For our project, we wanted to test different methods and packages to visualize animal
movement data. Specifically, we wanted to figure out the best way to create
maps and plots to best represent GPS data.

## Two Australian Invasive Lethal Species (TAILS)
We wanted to utilize data that was collected and uploaded to Movebank to familiarize 
ourselves with that platform. We found a unique data set of GPS collared feral cats and
European foxes in Australia. These mammals are both invasive to the area. We wanted to 
communicate their movement patterns and home range sizes in a comparative framework without
statistical analyses.


## Home ranges
Home ranges are a great way to start to visualize areas being used by individuals.
Here, we created minimum convex polygons (MCP) and kernel density estimators (KDE) for
three cats and three foxes in from August - November in 2017

## Visualization 1a: Home ranges: Cats
```{r}
# Creating home ranges for cats

# Read in libraries ----
library(dplyr)
library(lubridate)
library(amt)

# Read in data ----
# Cat GPS data and reference data
x <- read.csv("Data/Feral cat (Felis catus) - Scotia, NSW-reference-data.csv")
cat <- read.csv("Data/Feral cat (Felis catus) - Scotia, NSW.csv")

# Prepare the data ----
# Filter individuals in 2017 with greater than 600 data pints
cat_choice <- cat %>% 
  filter(year(timestamp) %in% 2017) %>% 
  group_by(individual.local.identifier) %>% 
  summarise(n = length(location.long)) %>% 
  filter(n >= 600) 
  
# Filter individuals in reference file to see metadata
cat_check <- x %>% 
  filter(animal.id %in% cat_choice$individual.local.identifier) 

# visualize in table the cats per year
table(x$animal.id, x$animal.sex, year(x$deploy.on.date))  

# Grab sex from reference data
sex <- x %>% 
  select(animal.id,
         animal.sex)

# Okay, not lets do some renaming
cat_choice <- cat %>% 
  filter(year(timestamp) %in% 2017) %>% 
  # select cols and rename
  select(animal.id = individual.local.identifier,
         y = location.lat,
         x = location.long,
         utm.y = utm.easting,
         utm.x = utm.northing,
         utm.zone,
         dt = timestamp) %>% 
  # join with ref data
  left_join(sex, by = "animal.id") %>% 
  # rename again
  rename(sex = animal.sex,
         id = animal.id) %>% 
  # filter time
  filter(hour(dt) %in% c(0, 6, 12, 18),
         month(dt) %in% 8:11) %>% 
  # change class of col
  mutate(x = as.numeric(x),
         y = as.numeric(y),
         dt = as.Date(dt)) %>% 
  # arrange asc date and time
  arrange(dt)


# Home range analysis:
# Make track for hr analysis
cat_track <- mk_track(tbl = cat_choice, .x = x, .y = y, .t = dt, 
                      id = id, crs = 23884)


# create hrs per cat
cat <- unique(cat_choice$id)
cat_mcp <- list()
cat_kde <- list()

# loop
for(i in 1:length(cat)){
  x <- cat_track %>% 
    filter(id == cat[i]) 
  
    cat_mcp[[i]] <- hr_mcp(x = x, 
                    levels = c(0.95, 0.5), 
                    keep.data = TRUE)
    
    # Fit KDE
    cat_kde[[i]] <- hr_kde(x = x,
                       levels = c(0.95, 0.5),
                       keep.data = TRUE,
                       h = hr_kde_ref(x), #default
                       trast = make_trast(x))
    

}

# name the list elements
names(cat_kde) <- names(cat_mcp) <- cat

# plot: minimum convex Polygon for 3 cats August - November 2017
plot(cat_mcp[[1]], main = "MCP: Ben", col = "coral")
plot(cat_mcp[[2]], main = "MCP: Ivy", col = "lightblue")
plot(cat_mcp[[3]], main = "MCP: Ken", col = "darkolivegreen3")

# plot: Kernel density Estimates for 3 cats August - November 2017
plot(cat_kde[[1]], main = "KDE: Ben", col = "coral")
plot(cat_kde[[2]], main = "KDE: Ivy", col = "lightblue")
plot(cat_kde[[3]], main = "KDE: Ken", col = "darkolivegreen3")


# To extract the areas from all MCPs
mcp_areas <- lapply(cat_mcp, hr_area)
kde_areas <- lapply(cat_kde, hr_area)

kde_df <- bind_rows(kde_areas, .id = "id")
mcp_df <- bind_rows(mcp_areas, .id = "id")



```


## Visualization 1b: Home ranges: Foxes

```{r pressure, echo=FALSE}
# Creating home ranges for foxs
library(dplyr)
library(lubridate)
library(amt)

# Read in data ----
# fox data and reference
x <- read.csv("Data/Red Fox (Vulpes vulpes) - Scotia, NSW, Australia-reference-data.csv")
x
fox <- read.csv("Data/Red Fox (Vulpes vulpes) - Scotia, NSW, Australia.csv")

# Filter individuals in 2017 with greater than 600 data pints
fox_choice <- fox %>% 
  filter(year(timestamp) %in% 2016) %>% 
  group_by(individual.local.identifier) %>% 
  summarise(n = length(location.long)) %>% 
  filter(n >= 600) 

# Filter individuals in reference file to see metadata
fox_check <- x %>% 
  filter(animal.id %in% fox_choice$individual.local.identifier) 

# visualize in table
table(x$animal.id, x$animal.sex, year(x$deploy.on.date))  

# Grab sex from reference data
sex <- x %>% 
  select(animal.id,
         animal.sex)

# Okay, not lets do some renaming
fox_choice <- fox %>% 
  filter(year(timestamp) %in% 2017) %>% 
  # select cols and rename
  select(animal.id = individual.local.identifier,
         y = location.lat,
         x = location.long,
         utm.y = utm.easting,
         utm.x = utm.northing,
         utm.zone,
         dt = timestamp) %>% 
  # join with ref data
  left_join(sex, by = "animal.id") %>% 
  # rename again
  rename(sex = animal.sex,
         id = animal.id) %>% 
  # filter time
  filter(hour(dt) %in% c(0, 6, 12, 18),
         month(dt) %in% 8:11) %>% 
  # change class of col
  mutate(x = as.numeric(x),
         y = as.numeric(y),
         dt = as.Date(dt)) %>% 
  # arrange asc date and time
  arrange(dt)

# make track for hr analysis
fox_track <- mk_track(tbl = fox_choice, .x = x, .y = y, .t = dt, 
                      id = id, crs = 23884)


# create hrs per fox
fox <- unique(fox_choice$id)
fox_mcp <- list()
fox_kde <- list()

# loop
for(i in 1:length(fox)){
  x <- fox_track %>% 
    filter(id == fox[i]) 
  
  fox_mcp[[i]] <- hr_mcp(x = x, 
                         levels = c(0.95, 0.5), 
                         keep.data = TRUE)
  
  # Fit KDE
  fox_kde[[i]] <- hr_kde(x = x,
                         levels = c(0.95, 0.5),
                         keep.data = TRUE,
                         h = hr_kde_ref(x), #default
                         trast = make_trast(x))
  
  
}

# name the list elements
names(fox_kde) <- names(fox_mcp) <- fox

# plot: MCP
plot(fox_mcp[[1]], main = "MCP: Ros", col = "aquamarine3")
plot(fox_mcp[[2]], main = "MCP: Flo", col = "darkorange")
plot(fox_mcp[[3]], main = "MCP: Joy", col = "brown3")

# plot: KDE
plot(fox_kde[[1]], main = "KDE: Ros", col = "aquamarine3")
plot(fox_kde[[2]], main = "KDE: Flo", col = "darkorange")
plot(fox_kde[[3]], main = "KDE: Joy", col = "brown3")
```

<<<<<<< HEAD
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


##Movetrack visualization: cats
Now that we can see static homeranges to visualize size and shape variance, we wanted to explore animating
the GPS location points to trace the movements of individuals and plot them on a map.
The package we used is called moveVis, which requires the data to be formatted as a "movestack" object. 

```{r}
library(tidyverse)
library(lubridate)
library(move)
library(moveVis)
library(RColorBrewer)
library(leaflet)

#load cat data from Movebank as Movestack
# create 'login'
loginStored <- movebankLogin(username="mbstum", password="Cq6j9m4KrQRQGJ@")
cats <- getMovebankData("Feral cat (Felis catus) - Scotia, NSW", login = loginStored, includeExtraSensors = TRUE)
# https://cran.r-project.org/web/packages/move/index.html

#subsetting cats dataset as a Movestack object
#visual data exploration to chose cats with the most gps fixes within a similar time period
#subset cats for only Aug - Nov 2017

#list of cats to use
cat_list <- c("Ben_MC236", "Ivy_FC489", "Ken_MC536", "Ray_MC729", "Roy_MC769" )

#subset movestack by cat names
subcats <- cats[[cat_list]]

#subset movestack by year
subcats <- subcats[year(timestamps(subcats))==2017] 

#subset movestack by months aug - nov
subcats <- subcats[month(timestamps(subcats))%in% c(8,9,10,11)]

#check timestamps
min(timestamps(subcats))
max(timestamps(subcats))

# align data to a uniform time scale, resample 4x daily
#reduces frames of movement animation to a resonable time
mC <- align_move(subcats, res = 6, unit = "hours")
```

##Interactive location maps
Before creating an animation, you can view all the location points for each individual
on an interactive map, which allows you to zoom in/out and hover over each point to view information.

```{r}
#colors for movement tracks
col = brewer.pal(n = 5, name = "Set2")

#create interactive map
view_spatial(mC, path_colours = col, render_as = "leaflet")
```

##Finally, animate the movement paths into a GIF

```{r}
# create spatial frames with a basemap 
frames <- frames_spatial(mC, path_colours = col,
                         tail_colour = "white", tail_size = 0.8, #how to include tail
                         trace_show = TRUE, trace_colour = "darkgray", #how to include path trace
                         map_service = 'osm', map_type = "terrain",
                         alpha = 0.5) %>% 
  add_labels(x = "Longitude", y = "Latitude") %>% # add some customizations, such as axis labels
  add_northarrow() %>% 
  add_scalebar() %>% 
  add_timestamps(type = "label") %>% 
  add_progress()

frames[[100]] # preview one of the frames, e.g. the 100th frame

animate_frames(frames, out_file = "catVis.gif", overwrite = TRUE)
```

## TO add:
- interactive map
- change map extent
- change tail color by group
- Next steps/what we weren't able to do
- Merge fox and cat movestack to plot both movetracks grouped by species on the same basemap animation
